# 跨页表格拼接的复杂性分析

## 为什么跨页表格拼接这么难？

### 1. 识别难：如何判断两个表格是同一张表？

#### 问题场景
```
第 45 页：
┌─────────────┬──────┬──────┐
│   项目      │ 2022 │ 2021 │
├─────────────┼──────┼──────┤
│ 流动资产    │ 1000 │  950 │
│   货币资金  │  500 │  480 │
│   应收账款  │  300 │  280 │
└─────────────┴──────┴──────┘

第 46 页：
┌─────────────┬──────┬──────┐
│   项目      │ 2022 │ 2021 │
├─────────────┼──────┼──────┤
│   存货      │  200 │  190 │
│ 非流动资产  │ 2000 │ 1900 │
└─────────────┴──────┴──────┘
```

**这是同一张表的续表吗？还是两张独立的表格？**

#### 判断依据不可靠

1. **表头相似 ≠ 同一张表**
   ```
   资产负债表可能有 3 处出现相同表头：
   - 第 10 页：合并资产负债表
   - 第 15 页：母公司资产负债表
   - 第 20 页：合并资产负债表（续）
   ```
   ❌ 简单的"表头匹配"会误拼接不同主体的报表

2. **页码连续 ≠ 表格连续**
   ```
   第 45 页：资产负债表（表格在页面底部）
   第 46 页：一段文字说明 + 利润表（新表格）
   ```
   ❌ 不能假设连续页的表格就是续表

3. **标题提示不统一**
   - 有的写"续表"、"（续）"
   - 有的什么都不写
   - 有的用页眉/页脚标注
   - 扫描件可能识别不出来

### 2. 拼接难：如何正确合并？

#### 问题 2.1：表头行数可能不一致

```
第 1 页（3 行表头）：
┌────┬────────┬────────┐
│项目│  2022  │  2021  │
│    ├───┬────┼───┬────┤
│    │Q1 │Q2  │Q1 │Q2  │
├────┼───┼────┼───┼────┤
│收入│100│200 │ 90│180 │
└────┴───┴────┴───┴────┘

第 2 页（2 行表头，缺了季度层）：
┌────┬────────┬────────┐
│项目│  2022  │  2021  │
├────┼───┬────┼───┬────┤
│成本│ 80│160 │ 70│140 │
└────┴───┴────┴───┴────┘
```

**如何对齐？**
- 如果第 2 页省略了季度行，需要补全
- 但如何知道是"省略"还是"本来就没有"？

#### 问题 2.2：列宽、列数可能变化

```
第 1 页：
┌──────────┬──────┬──────┬──────┐
│   项目   │ 2022 │ 2021 │ 2020 │
├──────────┼──────┼──────┼──────┤
│ 营业收入 │ 1000 │  950 │  900 │
└──────────┴──────┴──────┴──────┘

第 2 页（突然多了一列"增长率"）：
┌──────────┬──────┬──────┬──────┬────────┐
│   项目   │ 2022 │ 2021 │ 2020 │ 同比%  │
├──────────┼──────┼──────┼──────┼────────┤
│ 营业成本 │  800 │  760 │  720 │  5.26% │
└──────────┴──────┴──────┴──────┴────────┘
```

❌ 列数不一致，直接 `pd.concat()` 会错位

#### 问题 2.3：跨页断裂位置随机

```
情况 A（在数据行中间断开）：
第 1 页最后一行：│ 应收账款 │ 300 │ 280 │
第 2 页第一行：  │   存货   │ 200 │ 190 │
✅ 相对好处理

情况 B（在合并单元格中断开）：
第 1 页最后一行：│ 流动资产 │     │     │
第 2 页第一行：  │   小计   │1000 │ 950 │
❌ "流动资产"和"小计"是同一个合并单元格的两部分

情况 C（在多级表头中断开）：
第 1 页：表头第 1-2 行
第 2 页：表头第 3 行 + 数据
❌ 需要重建完整表头
```

### 3. 工程难：性能和鲁棒性

#### 问题 3.1：计算复杂度高

假设一份 100 页财报有 50 个表格：
- 需要两两比较相似度：C(50,2) = 1225 次比较
- 每次比较涉及：
  - 表头文本相似度（编辑距离）
  - 列数/列名匹配
  - 坐标位置计算
  - 数据类型一致性检查

**复杂度**: O(n² × m)，n=表格数，m=每表平均行数

#### 问题 3.2：误拼接的代价高

```
假设误拼接率 5%：
- 50 个表格中，2-3 个被错误拼接
- 结果：财务数据错误 → RAG 检索到错误数据 → LLM 给出错误分析

用户信任度 ↓↓↓
```

#### 问题 3.3：边界 case 太多

真实财报中遇到的奇葩情况：
1. **表格中间插入整页文字说明**
   ```
   第 10 页：资产负债表（上半部分）
   第 11 页：会计政策说明（全文字）
   第 12 页：资产负债表（下半部分）
   ```
   ❌ 需要跨页识别

2. **横向表格（旋转 90°）**
   ```
   竖版 PDF 中突然出现横向表格
   跨页后坐标系都变了
   ```

3. **嵌套表格**
   ```
   大表格里包含小表格
   拼接时可能把小表格当成大表格的一部分
   ```

4. **表格样式突变**
   ```
   第 1 页：有边框表格（camelot 能识别）
   第 2 页：无边框表格（只能用 stream 模式）
   → 同一张表用不同方法提取，格式不一致
   ```

### 4. 数据质量难：如何验证拼接正确？

#### 自动验证的困境

```python
# 人工标注 100 个跨页表格样本
# 算法拼接后对比

可能的结果：
✅ 完全正确：60%
⚠️  部分正确（丢了几行）：25%
❌ 完全错误：10%
❓ 无法判断（原表格就有问题）：5%
```

**问题**：
- "部分正确"算成功还是失败？
- 如何自动检测"丢了几行"？
- 无标注数据时怎么办？

#### 人工复核成本高

```
假设：
- 一份财报 10 个跨页表格
- 人工检查一个表格 2 分钟
- 100 份财报 = 2000 分钟 ≈ 33 小时

如果算法准确率 80%：
- 20% 需要人工修正
- 仍需 6.6 小时人工成本
```

### 5. 业界解决方案

#### 方案 A：规则匹配（准确率 60-70%）

```python
def is_continuation(table1, table2):
    checks = [
        table_header_similarity(table1, table2) > 0.9,  # 表头相似
        table1.page + 1 == table2.page,                 # 页码连续
        abs(table1.bottom - page_height) < 20,          # table1 在页底
        abs(table2.top) < 20,                           # table2 在页顶
        table1.columns == table2.columns,               # 列数相同
    ]
    return sum(checks) >= 4  # 满足 4/5 条件
```

**优点**：简单快速
**缺点**：边界 case 处理不好

#### 方案 B：机器学习（准确率 75-85%）

训练分类器判断两个表格是否是续表：
```
特征：
- 表头相似度
- 页面位置
- 列结构
- 数据类型分布
- 上下文文本

模型：XGBoost / BERT
```

**优点**：能学习复杂模式
**缺点**：需要大量标注数据

#### 方案 C：深度学习端到端（准确率 80-90%）

用 Transformer 模型理解整个文档结构：
```
输入：完整 PDF（图像 + OCR）
输出：JSON 结构化数据，表格自动拼接
```

**优点**：最高准确率
**缺点**：
- 需要 GPU
- 训练成本高（百万级样本）
- 黑盒，难以调试

#### 方案 D：人机协同（准确率 95%+）

```
1. 算法自动拼接
2. 低置信度的标记"需人工确认"
3. 提供可视化界面，人工快速确认/修正
```

**这是目前最实用的方案！**

### 6. 为什么建议延后？

#### 对比：MVP vs 跨页拼接

| 维度 | 基础抽取（阶段 1） | 跨页拼接（阶段 4） |
|------|-------------------|-------------------|
| 开发时间 | 3-5 天 | 3-5 天 |
| 覆盖率 | 80% 表格 | +15% 表格 |
| 准确率 | 90%+ | 70-80% |
| 风险 | 低 | 高（误拼接影响大） |
| 依赖 | 无 | 需要阶段 1 稳定 |

**ROI 分析**：
- 阶段 1：5 天获得 80% 覆盖率
- 阶段 4：5 天获得额外 15% 覆盖率（且质量不稳定）

**结论**：先把 80% 的基础能力做扎实，再优化剩余 20%

### 7. 我的建议

#### 短期（MVP）
```python
# 遇到跨页表格时
{
  "table_id": "tbl_001_part1",
  "page": 45,
  "is_partial": true,
  "continuation_hint": "此表格可能在下一页继续",
  "需要人工复核": true
}
```

#### 中期（阶段 2-3 稳定后）
实现**保守的**拼接策略：
```python
def safe_merge(table1, table2):
    # 只有极高置信度才自动拼接
    if all([
        exact_header_match(table1, table2),  # 表头完全一致
        exact_column_match(table1, table2),  # 列数、列名完全一致
        has_continuation_marker(table1),     # 明确标注了"续表"
        continuous_pages(table1, table2),    # 页码连续
    ]):
        return merge(table1, table2)
    else:
        return mark_as_separate_with_hint(table1, table2)
```

#### 长期（有资源时）
- 收集 200+ 跨页表格样本
- 训练专用模型
- 建立人工标注平台
- A/B 测试不同策略

## 总结

跨页拼接难在：
1. ❌ **识别难**：判断依据不可靠
2. ❌ **拼接难**：表头/列结构可能不一致
3. ❌ **工程难**：性能和边界 case
4. ❌ **验证难**：如何确保质量
5. ❌ **ROI 低**：投入产出比不高

**最佳实践**：
✅ 阶段 1-3：标记但不处理
✅ 阶段 4：保守策略 + 人工确认
✅ 长期：建立标注平台 + 模型训练

**现在的重点**：把 80% 的常规表格做到 95% 准确率！
