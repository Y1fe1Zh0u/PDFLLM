# 财务报表 RAG 系统增强实施计划

## 总体原则
- **先简后繁**：从矢量 PDF 开始，逐步支持扫描件
- **质量优先**：宁可少支持几种格式，也要保证准确率
- **快速验证**：每个阶段都要有可演示的成果

## 阶段 0：基础准备（1-2 天）

### 样本收集与分类
- [ ] 收集 6-8 份样本财报
  - 3 份矢量 PDF（年报、季报、10-K）
  - 2 份扫描 PDF
  - 1 份中英混排
  - 2 份包含跨页表格
- [ ] 为每份样本创建"期望输出"JSON 作为测试基准
- [ ] 统计表格类型分布（三大报表、附注、指标表等）

### 数据规范定义
```json
{
  "document_id": "abc123",
  "metadata": {
    "source_path": "uploads/2022-ACME-10K.pdf",
    "fiscal_year": 2022,
    "report_type": "10-K",
    "language": "zh-CN",
    "currency": "CNY"
  },
  "tables": [
    {
      "table_id": "tbl_001",
      "page": 52,
      "title": "合并资产负债表",
      "type": "balance_sheet",
      "unit": "百万元",
      "currency": "CNY",
      "headers": [
        {"level": 0, "text": "项目"},
        {"level": 0, "text": "2022年12月31日"},
        {"level": 0, "text": "2021年12月31日"}
      ],
      "rows": [
        {
          "metric": "流动资产",
          "标准指标名": "current_assets",
          "2022": 1000.5,
          "2021": 950.2
        }
      ],
      "extraction_method": "camelot_lattice",
      "confidence": 0.95,
      "需要人工复核": false
    }
  ],
  "sections": [...],
  "extraction_log": {
    "timestamp": "2024-01-01T12:00:00",
    "总页数": 120,
    "成功页数": 118,
    "失败页数": [45, 67]
  }
}
```

## 阶段 1：矢量 PDF 抽取（核心）（3-5 天）

### 目标
支持 80% 的标准格式财报（矢量 PDF，表格边框清晰）

### 技术栈
- **文本**: `pdfplumber`
- **表格**: `camelot-py` (lattice + stream 双模式)
- **兜底**: `pytesseract` (仅用于少量文字识别)

### 实现任务
- [x] 基础 PDF 文本提取（已完成 `pdf_extractor.py`）
- [ ] 增强表格提取
  - [ ] 双模式尝试：先 lattice，失败则 stream
  - [ ] 记录置信度和提取方法
  - [ ] 基础数值清洗（千分符、负号、百分比）
- [ ] 表头解析
  - [ ] 识别多行表头并合并
  - [ ] 提取单位和币种（从表格标题或表头）
  - [ ] 简单层级识别（一级、二级指标）
- [ ] 质量控制
  - [ ] 表格对齐检查（列数一致性）
  - [ ] 数值合理性检查（非空率、格式正确性）
  - [ ] 记录低置信度表格，标记"需人工复核"
- [ ] 单元测试
  - [ ] 针对 3 份矢量样本的集成测试
  - [ ] 对比期望输出，计算准确率

### 暂不实现
- ❌ 跨页表格拼接（标记为"跨页表格，分段提取"）
- ❌ 复杂版面分析
- ❌ OCR（除非 camelot 完全失败）

## 阶段 2：扫描件 OCR 兜底（3-4 天）

### 目标
对 camelot 失败的页面，自动切换 OCR 识别

### 技术栈
- **OCR**: `PaddleOCR` (优先) 或 `pytesseract`
- **版面**: `layoutparser` (可选)

### 实现任务
- [ ] OCR 触发逻辑
  - [ ] 检测是否为扫描件（文本提取为空或过少）
  - [ ] Camelot 置信度 < 0.5 时触发 OCR
- [ ] PaddleOCR 集成
  - [ ] 表格结构识别
  - [ ] 文字识别
  - [ ] 结果转换为标准 DataFrame
- [ ] 版面分析（可选）
  - [ ] 使用 layoutparser 检测表格区域
  - [ ] 裁剪后送入 OCR
- [ ] OCR 结果后处理
  - [ ] 表格重建（行列对齐）
  - [ ] 数值校正（常见 OCR 错误：0/O，1/l 等）
- [ ] 测试
  - [ ] 针对 2 份扫描样本验证

### 注意事项
- PaddleOCR 在 macOS CPU 上可能较慢，考虑异步处理
- 设置超时机制，避免卡死

## 阶段 3：语义增强与标准化（2-3 天）

### 目标
理解表格语义，标准化财务指标

### 实现任务
- [ ] 构建指标映射表
  ```json
  {
    "流动资产": {
      "标准名": "current_assets",
      "别名": ["流动资产合计", "Current Assets"],
      "报表类型": "balance_sheet",
      "单位": "金额"
    }
  }
  ```
- [ ] 表格类型识别
  - [ ] 从标题关键字判断（资产负债表、利润表、现金流量表）
  - [ ] 根据指标名推断
- [ ] 指标标准化
  - [ ] 匹配映射表，输出标准字段名
  - [ ] 提取 period（年度、季度）
  - [ ] 统一单位（万元→元，亿元→元）
- [ ] 上下文增强
  - [ ] 保存表格前后段落（用于 LLM 理解）
  - [ ] 记录表格引用关系（附注→主表）

## 阶段 4：跨页表格拼接（可选，3-5 天）

### 目标
自动识别并拼接跨页表格

### 策略
1. **表头匹配**：下一页表头与上一页相似度 > 80%
2. **坐标连续**：表格底部坐标接近页面底，且下页表格顶部接近页面顶
3. **标题一致**：表格标题相同或包含"续表"

### 实现任务
- [ ] 表头相似度计算（编辑距离）
- [ ] 跨页候选检测
- [ ] 拼接逻辑
- [ ] 人工确认接口（不确定时提示）

### 风险
- 误拼接率高，建议保留原始分段表格作为备份

## 阶段 5：工具与自动化（2 天）

### CLI 工具
```bash
# 批量抽取
python scripts/batch_extract.py --input data/uploads --output data/outputs

# 可视化对比
python scripts/visualize.py --pdf sample.pdf --json output.json

# 质量检查
python scripts/validate.py --json output.json
```

### 实现任务
- [ ] 批量抽取脚本
- [ ] 可视化工具（PDF vs 提取结果对比）
- [ ] 质量报告生成（准确率、覆盖率）
- [ ] 错误样例导出（供人工标注）

## 质量指标

### 阶段 1 目标
- 矢量 PDF 表格提取准确率 > 90%
- 数值字段准确率 > 95%
- 覆盖率：能处理 ≥ 3 种财报格式

### 阶段 2 目标
- 扫描件表格识别准确率 > 75%
- OCR 触发准确率（避免误触发）> 90%

### 阶段 3 目标
- 指标标准化覆盖率 > 70%（常见指标）
- 报表类型识别准确率 > 95%

## 技术债务与风险

### 已知限制
1. **跨页表格**：阶段 1-3 不支持，需人工处理或等阶段 4
2. **复杂版面**：图文混排、旋转表格暂不支持
3. **手写内容**：OCR 识别率低
4. **非标准报表**：小公司、特殊行业报表可能失败

### 缓解措施
- 提供"需人工复核"标记
- 保留原始 PDF 页面截图
- 设计人工标注接口，用于模型训练

## 时间估算

| 阶段 | 时间 | 优先级 |
|------|------|--------|
| 阶段 0 | 1-2 天 | P0 |
| 阶段 1 | 3-5 天 | P0 |
| 阶段 2 | 3-4 天 | P1 |
| 阶段 3 | 2-3 天 | P1 |
| 阶段 4 | 3-5 天 | P2 (可选) |
| 阶段 5 | 2 天 | P1 |

**总计**: 14-21 天（不含阶段 4）

## 下一步行动

1. ✅ 确认实施计划
2. ⬜ 收集样本财报
3. ⬜ 定义数据规范 JSON schema
4. ⬜ 开始阶段 1 开发
